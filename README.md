# AI 划词解释 Chrome 插件

一款浏览器划词AI解释插件，帮助用户在浏览网页时快速获取选中内容的AI智能解释。**支持上下文感知**，AI 能够理解网页内容并给出更准确的解释。

## ✨ 功能特性

### 核心功能
- **划词识别**：在网页上选中任意文字，自动显示"AI解释"按钮
- **智能解释**：点击按钮即可获取AI对选中内容的详细解释
- **🆕 上下文感知**：自动提取网页主要内容，AI 结合上下文给出更准确的解释
- **🆕 可视化反馈**：三层级高亮显示 AI 参考的上下文范围
- **多模型支持**：支持 OpenAI (GPT-4o, GPT-4o Mini 等) 和 Gemini (Google AI)
- **自定义配置**：支持自定义 API Endpoint、模型参数等
- **安全存储**：API Key 本地加密存储，不上传至任何服务器
- **Markdown 渲染**：支持代码高亮、列表等 Markdown 格式

### 🆕 上下文感知特性
- **智能内容提取**：使用 Mozilla Readability 算法自动识别网页正文
- **三层级高亮系统**：
  - 🟡 **Level 1**（最亮）：选中文本前后 ±3 段落（50% 透明度）
  - 🟡 **Level 2**（中等）：选中文本前后 ±5 段落（30% 透明度）
  - 🟡 **Level 3**（最淡）：其他参考内容（15% 透明度）
- **Token 智能管理**：
  - 经济模式：~2,000 tokens（适合快速解释）
  - 标准模式：~6,000 tokens（默认，平衡准确性和成本）
  - 精确模式：~12,000 tokens（适合复杂内容）
- **Prompt 模板系统**：
  - 默认模板：通用解释
  - 技术文档模板：适合技术文章
  - 学术论文模板：适合研究论文
  - 代码理解模板：适合代码片段
  - 自定义模板：支持用户自定义 Prompt

## 安装方法

### 开发模式安装

1. 克隆或下载本项目
```bash
git clone <repository-url>
cd ai-explanation-extension
```

2. 生成图标文件（参考 [src/assets/icons/README.md](src/assets/icons/README.md)）

3. 打开 Chrome 浏览器，进入扩展管理页面
   - 方式一：在地址栏输入 `chrome://extensions/`
   - 方式二：菜单 → 更多工具 → 扩展程序

4. 开启"开发者模式"（右上角开关）

5. 点击"加载已解压的扩展程序"

6. 选择项目根目录

7. 插件安装完成，点击插件图标进入设置页面

## 使用说明

### 首次配置

1. 点击浏览器工具栏中的插件图标
2. 在设置页面中配置基础设置：
   - 选择 AI 提供商（OpenAI 或 Gemini）
   - 输入你的 API Key（必填）
   - 选择要使用的模型
   - 可选：调整高级参数（Temperature、Max Tokens）
3. 配置上下文设置（推荐）：
   - 启用上下文感知（默认开启）
   - 选择上下文模式（经济/标准/精确）
   - 启用上下文高亮（推荐开启）
   - 选择 Prompt 模板（默认/技术文档/学术论文/代码/自定义）
4. 点击"保存配置"
5. 点击"测试连接"验证配置是否正确

### 获取 API Key

**OpenAI API Key:**
- 访问 [OpenAI Platform](https://platform.openai.com/api-keys)
- 登录后创建新的 API Key

**Gemini API Key:**
- 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
- 创建新的 API Key

### 日常使用

#### 基础使用
1. 在任意网页上用鼠标选中你想要解释的文字
2. 选区右上方会出现"AI解释"按钮
3. 点击按钮，等待AI分析
4. 解释结果会以弹窗形式展示，支持 Markdown 格式
5. 可以点击"复制"按钮复制解释内容

#### 🆕 上下文感知模式
1. 选中网页中的文字（如专业术语、技术概念）
2. 点击"AI解释"按钮
3. 插件会自动：
   - 提取网页主要内容
   - 在页面上用黄色高亮标记 AI 参考的上下文（三层级透明度）
   - 将上下文和选中文本一起发送给 AI
4. AI 会基于网页内容给出更准确、更符合语境的解释
5. 关闭弹窗后，高亮自动消失

**提示**：上下文功能特别适合以下场景：
- 📚 阅读技术文档时的专业术语
- 📖 浏览学术论文时的概念解释
- 💻 查看代码片段时的代码理解
- 🌐 阅读外语内容时的翻译和解释

### 快捷键

- `ESC` - 关闭解释弹窗

## 项目结构

```
ai-explanation-extension/
├── manifest.json              # Chrome 扩展配置文件 (v2.0.0)
├── package.json               # 项目配置
├── README.md                  # 项目说明
├── PRD.md                     # 产品需求文档
├── src/
│   ├── content/               # 内容脚本
│   │   ├── content.js         # 划词识别、按钮、弹窗逻辑、上下文集成
│   │   └── content.css        # 弹窗样式、三层级高亮样式
│   ├── background/            # 后台服务
│   │   └── service-worker.js  # API 调用、Prompt 模板系统
│   ├── options/               # 设置页面
│   │   ├── options.html       # 设置页面结构、上下文配置 UI
│   │   ├── options.js         # 设置页面逻辑、模板管理
│   │   └── options.css        # 设置页面样式
│   ├── utils/                 # 工具函数
│   │   ├── readability.js     # Mozilla Readability 内容提取库 🆕
│   │   ├── content-extractor.js  # 上下文提取器 🆕
│   │   ├── api.js             # API 请求封装
│   │   ├── storage.js         # 存储管理
│   │   └── markdown.js        # Markdown 渲染
│   └── assets/                # 静态资源
│       └── icons/             # 图标文件
└── tests/                     # 测试文件（待添加）
```

## 技术栈

- **Manifest V3** - Chrome 扩展最新标准
- **原生 JavaScript** - 无需构建工具，轻量高效
- **Chrome Storage API** - 本地数据存储
- **Chrome Runtime Messaging** - 组件间通信
- **Fetch API** - HTTP 请求
- **🆕 Mozilla Readability** - 智能内容提取算法
- **🆕 Template Engine** - Prompt 模板变量替换系统

## 支持的 AI 模型

### OpenAI
- GPT-4o
- GPT-4o Mini
- GPT-4 Turbo
- GPT-3.5 Turbo

### Gemini (Google AI)
- Gemini 1.5 Pro
- Gemini 1.5 Flash
- Gemini Pro

## 配置选项

### 基础配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| Provider | AI 提供商 | openai |
| API Key | API 访问密钥 | - |
| API Endpoint | API 端点地址 | 官方地址 |
| Model | 模型名称 | gpt-4o-mini |
| Temperature | 随机性控制 (0-2) | 0.7 |
| Max Tokens | 最大生成长度 | 1000 |

### 🆕 上下文配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 启用上下文感知 | 是否提取网页内容作为上下文 | ✅ 开启 |
| 上下文模式 | Token 预算级别 | 标准模式 (6K) |
| 启用高亮 | 是否在页面显示上下文高亮 | ✅ 开启 |
| Prompt 模板 | 解释使用的模板 | 默认模板 |

**上下文模式对比：**

| 模式 | Token 预算 | 适用场景 |
|------|-----------|----------|
| 经济模式 | ~2,000 tokens | 简单词汇、快速浏览 |
| 标准模式 | ~6,000 tokens | 日常阅读、平衡选择 ⭐ |
| 精确模式 | ~12,000 tokens | 复杂概念、专业文档 |

## 开发说明

### 本地开发

1. 修改代码后，在 `chrome://extensions/` 页面点击刷新按钮
2. 或者点击"重新加载"按钮重新加载扩展

### 调试

**Content Script 调试:**
1. 在任意网页上按 F12 打开开发者工具
2. 切换到 "Console" 标签
3. 可以看到 content.js 的日志输出

**Background Service Worker 调试:**
1. 在 `chrome://extensions/` 页面
2. 找到本插件，点击 "Service Worker" 链接
3. 打开独立的开发者工具窗口

**Options 页面调试:**
1. 在设置页面上按 F12 打开开发者工具

## 常见问题

### 1. 为什么点击"AI解释"按钮没有反应？

- 检查是否已配置 API Key
- 打开浏览器控制台查看错误信息
- 确认网络连接正常

### 2. API 调用超时怎么办？

- 检查网络连接
- 尝试更换 API Endpoint
- 如果使用代理，确保配置正确

### 3. 支持自定义 API 吗？

支持。在设置页面的"API Endpoint"中输入你的自定义地址即可。

### 4. 数据会上传到服务器吗？

不会。所有数据（包括 API Key）都存储在本地浏览器中，不会上传到任何第三方服务器。

### 5. 在某些网站上不工作？

某些网站可能会限制 Content Script 的运行，这是正常的安全限制。

### 6. 🆕 上下文功能会增加 API 成本吗？

会。上下文功能会增加 token 使用量，但提供：
- **经济模式**（~2K tokens）：成本增加很少
- **标准模式**（~6K tokens）：平衡选择，成本可控
- **精确模式**（~12K tokens）：成本较高，但解释更准确

建议根据使用场景选择合适的模式。

### 7. 🆕 为什么有些网页没有高亮显示？

可能的原因：
- 网页内容过少（少于 2 个段落）
- 内容提取失败（自动降级到无上下文模式）
- 在设置中关闭了高亮功能
- PDF 文档（特殊处理）

### 8. 🆕 如何自定义 Prompt 模板？

1. 打开设置页面
2. 在"Prompt 模板"部分选择"自定义模板"
3. 在编辑器中输入你的 Prompt
4. 可用变量：`{{pageTitle}}`, `{{pageUrl}}`, `{{context}}`, `{{selectedText}}`, `{{contextTokens}}`
5. 点击"预览模板"查看效果
6. 保存配置

## 隐私政策

- 本插件不收集任何用户数据
- API Key 仅存储在本地浏览器中
- 所有 API 请求直接发送到你配置的 API 端点
- 不进行任何用户行为追踪

## 版本历史

### v2.0.0 (2025-02-08) 🎉 重大更新

**✨ 上下文感知功能**
- 集成 Mozilla Readability 智能内容提取
- 三层级上下文高亮系统（50%/30%/15% 透明度）
- 距离优先的智能截断算法
- 支持三种上下文模式：经济/标准/精确
- 5 分钟缓存机制提升性能

**📝 Prompt 模板系统**
- 4 种预设模板：默认/技术文档/学术论文/代码
- 自定义模板编辑器
- 模板变量系统（`{{pageTitle}}`, `{{context}}` 等）
- 实时模板预览功能

**⚙️ 用户配置增强**
- 上下文模式选择（经济/标准/精确）
- 上下文高亮开关
- Prompt 模板选择和自定义
- 降级机制确保稳定性

**🔧 技术优化**
- 添加 PDF 文档检测和处理
- 动态内容等待加载
- Token 预算动态管理
- 内容提取失败自动降级

### v1.0.0 (2025-01-24)
- 初始版本发布
- 支持 OpenAI 和 Gemini API
- 基础划词解释功能
- 设置页面

## 后续计划

### 近期计划
- [ ] 支持更多 AI 模型（Claude、文心一言等）
- [ ] 历史记录功能（包含上下文）
- [ ] 快捷键支持
- [ ] 多语言界面
- [ ] 导出解释结果（包含上下文）

### 长期规划
- [ ] Web Worker 后台提取（性能优化）
- [ ] 智能上下文预加载
- [ ] 手动选择上下文范围
- [ ] 多源上下文聚合
- [ ] 上下文质量反馈机制

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License

## 联系方式

如有问题或建议，请提交 Issue。

---

**享受使用 AI 划词解释插件！**
